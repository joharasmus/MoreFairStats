@page "/"
@using System.Text.Json
@using Azure.Identity
@using Microsoft.Azure.Cosmos
@using MoreFairStats.Components
@inject Database dataBase

<PageTitle>Home</PageTitle>

<form @onsubmit="() => { return; }">
    <div class="input-group" style="width:25rem;">
        <span class="input-group-text border-warning" style="background-color:#10141f; color:#e7d5b3">View stats for round number</span>
        <input type="number" class="form-control border-warning" @bind="RoundNumber" @bind:event="oninput"/>
        <button type="button" class="btn btn-outline-warning" @onclick="(() => RoundNumber--)">&#8722;</button>
        <button type="button" class="btn btn-outline-warning" @onclick="(() => RoundNumber++)">&#43;</button>
    </div>
</form>
<br>

@if(roundStats != null)
{
    <div class="card border border-warning" style="width:50rem; background-color:#10141f; color:#e7d5b3">
        <div class="card-body">
            <h3 class="card-title">Stats for round @roundStats.Number</h3>
        </div>
    </div>
    <div class="card-group" style="width:50rem; background-color:#10141f; color:#e7d5b3">
        <div class="card border-warning" style="background-color:#10141f; color:#e7d5b3">
            <div class="card-header border-warning">Round info</div>
            <div class="card-body">
                <p>Base points: <b>@Int64.Parse(roundStats.BasePointsToPromote!).ToString("N0")</b></p>
                <p class="card-text">Round types: @string.Join(", ", roundStats.RoundTypes!)</p>
            </div>
        </div>
            <div class="card border-warning" style="background-color:#10141f; color:#e7d5b3">
            <div class="card-header border-warning">Round start</div>
            <div class="card-body">
                <p class="card-text">Date: @roundStats.CreatedOn!.Substring(0, 19).Split('T')[0]</p>
                <p class="card-text">Time: @roundStats.CreatedOn!.Substring(0, 19).Split('T')[1]</p>
            </div>
        </div>
        <div class="card border-warning" style="background-color:#10141f; color:#e7d5b3">
            <div class="card-header border-warning">Round ending</div>
            <div class="card-body">
                <p class="card-text">Date: @roundStats.ClosedOn!.Substring(0, 19).Split('T')[0]</p>
                <p class="card-text">Time: @roundStats.ClosedOn!.Substring(0, 19).Split('T')[1]</p>
            </div>
        </div>
    </div>
    <br>

    <RankersTable roundStats="@roundStats" ladderStats="@ladderStats" OnLadderClickCallback="@updateLadderNumber" ></RankersTable>
}


@code{
    private int currentMaxRound => statsConfig!.CurrentMaxRound;

    private int _roundNumber;

    private int RoundNumber 
    { 
        get => _roundNumber;
        set 
        { 
            _roundNumber = value < 1 ? 1 : (value > currentMaxRound ? currentMaxRound : value);
            updateRoundNumber();
        }
    }

    private NewRoundStats? roundStats;

    private RoundStats? oldRoundStats;

    private LadderStats? ladderStats;

    private Config? statsConfig;


    protected override async Task OnInitializedAsync()
    {
        parseStatsConfig();
        await getRoundStats(currentMaxRound);
        RoundNumber = currentMaxRound;
        //UpdatePlayersWithNewNames();
        //invertRoundsToPlayers();
    }

    private async void updateRoundNumber()
    {
        await parseRoundStats(RoundNumber);
        ladderStats = await parseLadderStats(RoundNumber, roundStats!.NumberOfLadders); //Always use the last ladder, which has the same number as the count
        StateHasChanged();
    }

    private async void updateLadderNumber(string ladderNum)
    {
        var intLadderNum = Int32.Parse(ladderNum);
        ladderStats = await parseLadderStats(RoundNumber, intLadderNum);
        StateHasChanged();
    }

    private void parseStatsConfig()
    {
        var workingDirectory = Environment.CurrentDirectory;
        var fileName = workingDirectory + $"\\Data\\config.json";
        var jsonString = File.ReadAllText(fileName);
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        statsConfig = JsonSerializer.Deserialize<Config>(jsonString, options);
    }

    private async Task parseRoundStats(int round)
    {
        var container = dataBase.GetContainer("mfs-rounds");
        var respItem = await container.ReadItemAsync<NewRoundStats>(round.ToString(), new PartitionKey(round));
        roundStats = respItem.Resource;
    }

    private async Task<LadderStats> parseLadderStats(int round, int ladder)
    {
        var container = dataBase.GetContainer("mfs-ladders");
        var respItem = await container.ReadItemAsync<LadderStats>($"R{round}L{ladder}", new PartitionKey(round));
        return respItem.Resource;
    }

    private async Task getRoundStats(int round)
    {
        var client = new HttpClient();
        var response = await client.GetAsync($"https://fair.kaliburg.de/api/stats/round/raw?number={round}");
        var bodyString = await response.Content.ReadAsStringAsync();
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        var roundData = JsonSerializer.Deserialize<RoundStats>(bodyString, options);
        var newRoundStats = new NewRoundStats()
        {
            BasePointsToPromote = roundData!.BasePointsToPromote,
            ClosedOn = roundData.ClosedOn,
            CreatedOn = roundData.CreatedOn,
            Number = roundData.Number,
            NumberOfLadders = roundData.Ladders!.Count,
            RoundTypes = roundData.RoundTypes,
            id = roundData.Number.ToString()
        };
        var newRoundStatsString = JsonSerializer.Serialize(newRoundStats);
        var dataDirectory = Environment.CurrentDirectory + "\\Data";
        var roundStatsFilePath = dataDirectory + $"\\Rounds\\R{round}.json";
        File.WriteAllText(roundStatsFilePath, newRoundStatsString);
        foreach (var ladder in roundData.Ladders)
        {
            var ladderStats = ladder.Value;
            ladderStats.Round = round;
            ladderStats.Ladder = int.Parse(ladder.Key);
            ladderStats.id = $"R{round}L{ladder.Key}";
            var ladderStatsString = JsonSerializer.Serialize(ladderStats);
            var ladderStatsPath = dataDirectory + $"\\Ladders\\R{round}L{ladder.Key}.json";
            File.WriteAllText(ladderStatsPath, ladderStatsString);
        }
    }

    private async void UpdatePlayersWithNewNames()
    {
        var firstLadder = await parseLadderStats(currentMaxRound, 1);
        var firstLadderRankers = firstLadder.Rankers;
        var dirInfo = new DirectoryInfo("C:\\Users\\admin\\source\\repos\\MoreFairStats\\MoreFairStats\\Data\\Ladders\\");
        var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
        foreach (var ladderFile in dirInfo.GetFiles())
        {
            var ladderFilePath = ladderFile.FullName;
            Console.WriteLine(ladderFilePath);
            var ladderJson = File.ReadAllText(ladderFilePath);
            var ladder = JsonSerializer.Deserialize<LadderStats>(ladderJson, options);
            foreach (var ranker in ladder!.Rankers!)
            {
                var matchRanker = firstLadderRankers!.Find(r => r.AccountId == ranker.AccountId);
                if (matchRanker == null) continue;
                ranker.UserName = matchRanker.UserName;
                ranker.AssholePoints = matchRanker.AssholePoints;
            }
            var jsonString = JsonSerializer.Serialize(ladder);
            File.WriteAllText(ladderFilePath, jsonString);
        }
    }

    // private void invertRoundsToPlayers()
    // {
    //     var allRankers = new SortedDictionary<int, PlayerStats>();
    //     for (int i = 1; i <= currentMaxRound; i++)
    //     {
    //         parseRoundStats(i);
    //         var firstLadder = roundStats!.Ladders!["1"];
    //         foreach (var ranker in firstLadder.Rankers!)
    //         {
    //             if (!allRankers.ContainsKey(ranker.AccountId))
    //             {
    //                 var player = new PlayerStats() { AccountId = ranker.AccountId, AHPoints = ranker.AssholePoints, UserName = ranker.UserName };
    //                 allRankers[ranker.AccountId] = player;
    //             }
    //             var roundApp = new RoundAppearance()
    //                 {
    //                     Ladders = [],
    //                     RoundTypes = roundStats.RoundTypes,
    //                     BasePointsToPromote = roundStats.BasePointsToPromote,
    //                     CreatedOn = roundStats.CreatedOn,
    //                     ClosedOn = roundStats.ClosedOn,
    //                     Number = roundStats.Number
    //                 };
    //             allRankers[ranker.AccountId].RoundAppearances!.Add(roundApp);
    //             foreach (var keyVal in roundStats.Ladders)
    //             {
    //                 var ladderNum = keyVal.Key;
    //                 var ladder = keyVal.Value;
    //                 var ladderRanker = ladder.Rankers!.Find(r => r.AccountId == ranker.AccountId);
    //                 var ladderApp = new LadderAppearance()
    //                     {
    //                         CreatedOn = ladder.CreatedOn,
    //                         BasePointsToPromote = ladder.BasePointsToPromote,
    //                         LadderTypes = ladder.LadderTypes,
    //                         Rank = ladderRanker!.Rank,
    //                         Points = ladderRanker.Points,
    //                         Power = ladderRanker.Power,
    //                         Multi = ladderRanker.Multi,
    //                         Bias = ladderRanker.Bias,
    //                         Grapes = ladderRanker.Grapes,
    //                         Vinegar = ladderRanker.Vinegar,
    //                         AutoPromote = ladderRanker.AutoPromote,
    //                         Growing = ladderRanker.Growing
    //                     };
    //                 roundApp.Ladders[ladderNum] = ladderApp;
    //                 if (ladderRanker.Growing) break;
    //             }

    //         }
    //         Console.WriteLine(i);
    //     }
    //     var tunaStats = allRankers[36780];
    //     foreach (var appearance in tunaStats.RoundAppearances)
    //     {
    //         Console.WriteLine(appearance.Number);
    //         Console.WriteLine(appearance.Ladders!.Values.Last().Vinegar);
    //     }
    //     var jsonString = JsonSerializer.Serialize(allRankers);
    //     Console.WriteLine("Serialized!");
    //     var fileName = "allRankers.json";
    //     var filePath = Environment.CurrentDirectory + $"\\Data\\{fileName}";
    //     File.WriteAllText(filePath, jsonString);
    // }
}