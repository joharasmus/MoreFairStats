<!--
***********************************************************************************************
Microsoft.NET.Sdk.Razor.Component.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved.
***********************************************************************************************
-->

<Project ToolsVersion="14.0">

  <PropertyGroup>
    <_RazorGenerateComponentDeclarationDesignTimeDependsOn>RazorGenerateComponentDeclaration</_RazorGenerateComponentDeclarationDesignTimeDependsOn>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Used for tracking inputs to component generation -->
    <_RazorComponentInputHash></_RazorComponentInputHash>
    <_RazorComponentInputCacheFile>$(IntermediateOutputPath)$(MSBuildProjectName).RazorComponent.input.cache</_RazorComponentInputCacheFile>
    <_RazorComponentDeclarationOutputCacheFile>$(IntermediateOutputPath)$(MSBuildProjectName).RazorComponent.output.cache</_RazorComponentDeclarationOutputCacheFile>
  </PropertyGroup>

  <ItemGroup>
    <!-- Path used for the temporary compilation we produce for component discovery -->
    <_RazorComponentDeclarationAssembly Include="$(_RazorComponentDeclarationOutputPath)$(TargetName).dll" />
  </ItemGroup>

  <Target Name="_HashRazorComponentInputs" Condition="'@(RazorComponentWithTargetPath->Count())'!='0'">
    <Hash ItemsToHash="@(RazorComponentWithTargetPath)">
      <Output TaskParameter="HashResult" PropertyName="_RazorComponentInputHash" />
    </Hash>

    <MakeDir
      Directories="$(IntermediateOutputPath)"
      Condition="!Exists('$(IntermediateOutputPath)')" />

    <WriteLinesToFile
      Lines="$(_RazorComponentInputHash)"
      File="$(_RazorComponentInputCacheFile)"
      Overwrite="True"
      WriteOnlyWhenDifferent="True" />

    <ItemGroup>
      <FileWrites Include="$(_RazorComponentInputCacheFile)" />
    </ItemGroup>
  </Target>

  <Target Name="_ResolveRazorComponentOutputs" Condition="'@(RazorComponentWithTargetPath->Count())'!='0'">
    <Error
      Text="RazorComponentWithTargetPath item '%(RazorComponentWithTargetPath.Identity)' does not specify required metadata 'GeneratedDeclaration'."
      Condition="'%(RazorComponentWithTargetPath.GeneratedDeclaration)' == ''" />

    <ItemGroup>
      <_RazorComponentDeclaration Include="@(RazorComponentWithTargetPath->'%(GeneratedDeclaration)')">
        <DependentUpon>%(Identity)</DependentUpon>
      </_RazorComponentDeclaration>
      <_RazorComponentDefinition Include="%(RazorComponentWithTargetPath.GeneratedOutput)" />
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <RazorGenerateComponentDeclarationDependsOn>
      _HashRazorComponentInputs;
      _ResolveRazorComponentOutputs;
    </RazorGenerateComponentDeclarationDependsOn>
  </PropertyGroup>

  <!--
    Generates 'declaration' files for each component, that only have that class and member declarations.
    These files participate in the design-time-build for intellisense, and are used at build-time
    when discovering components for a 'real' build.
  -->
  <Target
    Name="RazorGenerateComponentDeclaration"
    DependsOnTargets="$(RazorGenerateComponentDeclarationDependsOn)"
    Inputs="$(MSBuildAllProjects);@(RazorComponentWithTargetPath);$(_RazorComponentInputCacheFile)"
    Outputs="$(_RazorComponentDeclarationOutputCacheFile)"
    Condition="'@(RazorComponentWithTargetPath->Count())'!='0'">

    <ItemGroup>
      <_RazorComponentDeclarationSources Include="@(RazorComponentWithTargetPath)">
        <GeneratedOutput>%(RazorComponentWithTargetPath.GeneratedDeclaration)</GeneratedOutput>
      </_RazorComponentDeclarationSources>
    </ItemGroup>

    <MakeDir
      Directories="%(_RazorComponentDeclaration.RelativeDir)"
      Condition="!Exists('%(_RazorComponentDeclaration.RelativeDir)')" />

    <PropertyGroup>
      <!-- This file will not exist, but we need some value -->
      <_RazorComponentDeclarationManifest>$(IntermediateOutputPath)$(MSBuildProjectName).RazorComponents.declaration.json</_RazorComponentDeclarationManifest>
    </PropertyGroup>

    <SdkRazorGenerate
      Debug="$(_RazorDebugGenerateCodeTask)"
      DebugTool="$(_RazorDebugGenerateCodeTool)"
      ToolExe="$(_RazorSdkDotNetHostFileName)"
      ToolPath="$(_RazorSdkDotNetHostDirectory)"
      ToolAssembly="$(_RazorSdkToolAssembly)"
      UseServer="$(UseRazorBuildServer)"
      ForceServer="$(_RazorForceBuildServer)"
      PipeName="$(_RazorBuildServerPipeName)"
      Version="$(RazorLangVersion)"
      RootNamespace="$(RootNamespace)"
      CSharpLanguageVersion="$(LangVersion)"
      Configuration="@(ResolvedRazorConfiguration)"
      Extensions="@(ResolvedRazorExtension)"
      Sources="@(_RazorComponentDeclarationSources)"
      ProjectRoot="$(MSBuildProjectDirectory)"
      TagHelperManifest="$(_RazorComponentDeclarationManifest)"
      GenerateDeclaration="true" />

    <Touch
      Files="$(_RazorComponentDeclarationOutputCacheFile)"
      AlwaysCreate="true" />

    <ItemGroup>
      <FileWrites Include="@(_RazorComponentDeclaration)" />
      <FileWrites Include="$(_RazorComponentDeclarationOutputCacheFile)" />
    </ItemGroup>
  </Target>

</Project>
